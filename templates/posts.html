{% extends "layout.html" %}

{% block optional_c %}
    <link href="/static/styles/posts.css" rel="stylesheet">
{% endblock %}

{% block title %}
    Posts
{% endblock %}

{% block main %}
    <div class="container-main">
        <div class="bar">
            <div id="posts-logo">
                <div>
                    <img src="/static/images/friends-icon.png" alt="posts-logo" width="40px">
                    <span>Posts</span>
                </div>
            </div>
            <div id="tabs">
                <div>
                    <a href="/createpost"><button id="search_button" class="btn btn-primary btn-prof btn-tab">Create A Post</button></a>
                    <button id="my_button" class="btn btn-primary btn-prof btn-tab">My Posts</button>
                    <button id="friends_button" class="btn btn-primary btn-prof btn-tab">Friends' Posts</button>
                </div>
            </div>
        </div>
        <br>
        <div id="my_posts" class="o-profile" style="padding-top: 1rem;">
            <h4>My Posts</h4>
            {% if my_posts %}
                {% for post in my_posts %}
                    <div class="posts" id="{{ post['id'] }}" data-value = "{{ post['status'] }}">
                        <div class="post-box">
                            <div class="top-part">
                                <div class="user-info">
                                    <a href="/profile"><div class="profile-pic-post"><img src="/static/images/user_profile_pic.png"></div></a>
                                    <div style="margin-left: 0.5vw; text-align: left;">
                                        <div class="name"><a href="/profile">{{ my_name }}</a></div>
                                        <div class="username"><a href="/profile">@{{ my_username }}</a></div>
                                    </div>
                                </div>
                                <div class="post-title"><a href="/post?id={{ post['id'] }}">{{ post["title"] }}</a></div>
                                <div class="post-timestamp">
                                    <div>{{ post['date'] }}</div>
                                    <div>{{ post['time'] }}</div>
                                </div>
                            </div>
                            <div>
                                {% if post['imagelocation'] %}
                                    <div class="post-image">
                                        <img src="{{ post['imagelocation'] }}"></img>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="contents">
                                {{ post["contents"] }}
                            </div>
                            <div class="tags">
                                {% for tag in post["tags"] %}
                                    <div class="tag">#{{ tag }}</div>
                                {% endfor %}
                            </div>
                            <div class="actions">
                                <div class="btn-left">
                                    <button name="like_button" value="{{ post['id'] }}" class="action-button btn-big" type="button">
                                        {% if post["status"] == 1 %}
                                            <img src="/static/images/like.png">
                                        {% else %}
                                            <img src="/static/images/like-uncolored.png">
                                        {% endif %}
                                    </button>
                                    <div class="like_count">
                                        {{ post["likes"] }}
                                    </div>
                                    <button name="dislike_button" value="{{ post['id'] }}" class="action-button btn-big" type="button">
                                        {% if post["status"] == 2 %}
                                            <img src="/static/images/dislike.png">
                                        {% else %}
                                            <img src="/static/images/dislike-uncolored.png">
                                        {% endif %}
                                    </button>
                                    <a href="/post?id={{ post['id'] }}#comments"><button name="comment_button" value="{{ post['id'] }}" comment_count="{{ post['comments'] }}" class="action-button" type="button"><img src="/static/images/comments.png"></button></a>
                                    <button name="share_button" value="{{ post['id'] }}" class="action-button" type="button"><img src="/static/images/share.png"></button>
                                </div>
                                <div class="warning" style="width: 40%; font-size: medium;"></div>
                                <div class="btn-right">
                                    <a href="/edit_post?post_id={{ post['id'] }}"><button  name="edit_button" value="{{ post['id'] }}" class="action-button" type="button"><img src="/static/images/edit.png" style="height: 3rem; "></button></a>
                                    <button  name="delete_button" value="{{ post['id'] }}" class="action-button" type="button"><img src="/static/images/delete.png"> </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                <div id="delete_popup" style="display: none" class="popup">
                    <h3>Title: <span id="popup_title"></span></h3>
                    Likes: <span id="popup_likes"></span>
                    Comments: <span id="popup_comments"></span>
                    <h4>Delete post? This is an irreversible action.</h4>
                    <form>
                        <button class="btn btn-primary btn-prof" type="button" id="delete_yes" value="yes">Yes</button>
                        <button class="btn btn-primary btn-prof" type="button" id="delete_no" value="no">No</button>
                    </form>
                </div>
            {% else %}
                This place seems empty. Perhaps considering lightening it up?
                <a href="/createpost">Create a post?</a>
                <br>
            {% endif %}
        </div>

        <div id="friend_posts" style="display: none;" class="o-profile" style="padding-top: 1rem;">
            <h4 style="margin-top: 10px;">Friends' Posts</h4>
            {% if friend_posts %}
                {% for post in friend_posts %}
                    <div class="posts" id="{{ post['id'] }}" data-value = "{{ post['status'] }}">
                        <div class="post-box">
                            <div class="top-part">
                                <div class="user-info">
                                    <a href="/profile?username={{ post['username'] }}"><div class="profile-pic-post"><img src="/static/images/user_profile_pic.png"></div></a>
                                    <div style="margin-left: 0.5vw; text-align: left;">
                                        <div class="name"><a href="/profile?username={{ post['username'] }}">{{ post["fullname"] }}</a></div>
                                        <div class="username"><a href="/profile?username={{ post['username'] }}">@{{ post["username"] }}</a></div>
                                    </div>
                                </div>
                                <div class="post-title"><a href="/post?id={{ post['id'] }}">{{ post["title"] }}</a></div>
                                <div class="post-timestamp">
                                    <div>{{ post['date'] }}</div>
                                    <div>{{ post['time'] }}</div>
                                </div>
                            </div>
                            <div>
                                {% if post["imagelocation"] %}
                                    <div class="post-image">
                                        <img src="{{ post['imagelocation'] }}"></img>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="contents">
                                {{ post["contents"] }}
                            </div>
                            <div class="tags">
                                {% for tag in post["tags"] %}
                                    <div class="tag">#{{ tag }}</div>
                                {% endfor %}
                            </div>
                            <div class="actions">
                                <div class="btn-left">
                                    <button name="like_button" value="{{ post['id'] }}" class="action-button btn-big" type="button">
                                        {% if post["status"] == 1 %}
                                            <img src="/static/images/like.png">
                                        {% else %}
                                            <img src="/static/images/like-uncolored.png">
                                        {% endif %}
                                    </button>
                                    <div class="like_count">
                                        {{ post["likes"] }}
                                    </div>
                                    <button name="dislike_button" value="{{ post['id'] }}" class="action-button btn-big" type="button">
                                        {% if post["status"] == 2 %}
                                            <img src="/static/images/dislike.png">
                                        {% else %}
                                            <img src="/static/images/dislike-uncolored.png">
                                        {% endif %}
                                    </button>
                                    <a href="/post?id={{ post['id'] }}#comments"><button name="comment_button" value="{{ post['id'] }}" comment_count="{{ post['comments'] }}" class="action-button" type="button"><img src="/static/images/comments.png"></button></a>
                                    <button name="share_button" value="{{ post['id'] }}" class="action-button" type="button"><img src="/static/images/share.png"></button>
                                    <div class="warning" style="width: 40%; font-size: medium;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                This place seems empty. Perhaps remind your friends to post more often?
                <br>
            {% endif %}
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Tab Management
            const my_posts = document.getElementById('my_posts');
            const friend_posts = document.getElementById('friend_posts');
            const popup = document.getElementById('delete_popup');
            document.getElementById('my_button').onclick = function() {
                my_posts.style.display = 'block';
                friend_posts.style.display = 'none';
            };
            document.getElementById('friends_button').onclick = function() {
                friend_posts.style.display = 'block';
                my_posts.style.display = 'none';
                popup.style.display = 'none';
            };

            const like_buttons = document.getElementsByName('like_button');
            const dislike_buttons = document.getElementsByName('dislike_button');

            const share_buttons = document.getElementsByName('share_button');

            const delete_buttons = document.getElementsByName('delete_button');

            // Like post
            for (let like_button of like_buttons) {
                like_button.onclick = async function() {
                    // Disable button for a short period
                    like_button.disabled = true;

                    var post_id = like_button.value;
                    var status = document.getElementById(post_id).getAttribute('data-value');

                    var like_count = document.getElementById(post_id).querySelector('.like_count');
                    if (!like_count) {
                        window.location.reload();
                    }

                    var aj = new XMLHttpRequest();
                    aj.onreadystatechange = async function() {
                        if (aj.readyState == 4 && aj.status == 200) {
                            var data = JSON.parse(aj.responseText);

                            if (data.result) {
                                var button_image = like_button.querySelector('img');

                                // Manages active dislike button of a post when like button is clicked
                                document.getElementById(post_id).querySelector('[name="dislike_button"]').querySelector('img').src = "/static/images/dislike-uncolored.png";

                                if (status == 1) {
                                    // Unliked
                                    button_image.src = "/static/images/like-uncolored.png";
                                    like_count.innerHTML = parseInt(like_count.innerHTML) - 1;
                                    status = 0;
                                } else {
                                    // Liked
                                    button_image.src = "/static/images/like.png";

                                    if (status == 0) {
                                        like_count.innerHTML = parseInt(like_count.innerHTML) + 1;
                                    } else {
                                        like_count.innerHTML = parseInt(like_count.innerHTML) + 2;
                                    }

                                    status = 1;
                                }

                                // Update post interaction status
                                document.getElementById(post_id).setAttribute('data-value', status);


                                // Enable button after 1500 ms
                                setTimeout(function() {
                                    like_button.disabled = false;
                                }, 1500);
                            }
                        }
                    };

                    aj.open("POST", "/manage_likes", true);
                    aj.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    aj.setRequestHeader("X-Requested-With", "XMLHttpRequest");
                    aj.send("post_id=" + post_id + "&action=" + "like");
                };
            }

            // Dislike post
            for (let dislike_button of dislike_buttons) {
                dislike_button.onclick = async function() {
                    // Disable button for a short period
                    dislike_button.disabled = true;

                    var post_id = dislike_button.value;
                    var status = document.getElementById(post_id).getAttribute('data-value');

                    var like_count = document.getElementById(post_id).querySelector('.like_count');
                    if (!like_count) {
                        window.location.reload();
                    }

                    var aj = new XMLHttpRequest();
                    aj.onreadystatechange = async function() {
                        if (aj.readyState == 4 && aj.status == 200) {
                            var data = JSON.parse(aj.responseText);

                            if (data.result) {
                                var button_image = dislike_button.querySelector('img');

                                // Manages active like button of a post when dislike button is clicked
                                document.getElementById(post_id).querySelector('[name="like_button"]').querySelector('img').src = "/static/images/like-uncolored.png";

                                if (status == 2) {
                                    // Removed Dislike
                                    button_image.src = "/static/images/dislike-uncolored.png";
                                    like_count.innerHTML = parseInt(like_count.innerHTML) + 1;
                                    status = 0;
                                } else {
                                    // Disliked
                                    button_image.src = "/static/images/dislike.png";

                                    if (status == 0) {
                                        like_count.innerHTML = parseInt(like_count.innerHTML) - 1;
                                    } else {
                                        like_count.innerHTML = parseInt(like_count.innerHTML) - 2;
                                    }

                                    status = 2;
                                }

                                // Update post interaction status
                                document.getElementById(post_id).setAttribute('data-value', status);

                                // Enable button after 1500 ms
                                setTimeout(function() {
                                    dislike_button.disabled = false;
                                }, 1500);
                            }
                        }
                    };

                    aj.open("POST", "/manage_likes", true);
                    aj.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    aj.setRequestHeader("X-Requested-With", "XMLHttpRequest");
                    aj.send("post_id=" + post_id + "&action=" + "dislike");
                };
            }

            // Share button
            for (let share_button of share_buttons) {
                share_button.onclick = function() {
                    event.preventDefault();

                    var post_id = share_button.value;
                    var url = "http://127.0.0.1:5000/post?id=" + post_id;

                    warning = document.getElementById(post_id).querySelector('.warning');

                    navigator.clipboard.writeText(url).then(function() {
                        warning.style.color = "green";
                        warning.innerHTML = "Post link copied to clipboard!";
                    }, function(err) {
                        warning.style.color = "red";
                        warning.innerHTML = "Could not copy link to clipboard!";
                    });
                    setTimeout(function() {
                        warning.innerHTML = "";
                    }, 1500);
                }
            }

            // Manage post deletion
            for (let delete_button of delete_buttons) {
                delete_button.onclick = function() {
                    var post_id = delete_button.value;
                    document.getElementById('popup_title').innerHTML = document.getElementById(post_id).querySelector('.post-title').innerHTML;
                    document.getElementById('popup_likes').innerHTML = document.getElementById(post_id).querySelector('.like_count').innerHTML;
                    document.getElementById('popup_comments').innerHTML = document.getElementById(post_id).querySelector('[name = "comment_button"]').getAttribute('comment_count');

                    popup.style.display = 'block';
                    document.body.style.overflow = 'hidden';

                    document.getElementById('delete_yes').onclick = async function() {
                        var aj = new XMLHttpRequest();

                        aj.onreadystatechange = async function() {
                            if (aj.readyState == 4 && aj.status == 200) {
                                var data = JSON.parse(aj.responseText);
                                if (data.result) {
                                    document.getElementById(post_id).remove();
                                    popup.style.display = 'none';
                                    document.body.style.overflow = 'auto';
                                }
                            }
                        };

                        aj.open("POST", "/delete_post", true);
                        aj.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                        aj.setRequestHeader("X-Requested-With", "XMLHttpRequest");
                        aj.send("post_id=" + post_id);
                    };

                    document.getElementById('delete_no').onclick = function() {
                        popup.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    };
                };
            }
        });
    </script>
{% endblock %}